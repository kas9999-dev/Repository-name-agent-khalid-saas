<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nashr — App</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-title">Nashr</div>
        <div class="brand-sub">Demo Version • 2025 ©</div>
      </div>
      <div class="header-links">
        <a href="/health" class="chip">health</a>
        <span class="chip">API: /api/run</span>
      </div>
    </header>

    <main class="app-main">
      <section class="card">
        <div class="field">
          <label for="text">الفكرة / الموضوع</label>
          <textarea id="text" rows="6" placeholder="اكتب الفكرة هنا..."></textarea>
        </div>

        <div class="row">
          <div class="field">
            <label for="platform">المنصة</label>
            <select id="platform">
              <option value="linkedin_x" selected>LinkedIn + X</option>
              <option value="linkedin">LinkedIn</option>
              <option value="x">X</option>
            </select>
          </div>

          <div class="field">
            <label for="tone">النبرة</label>
            <select id="tone">
              <option value="professional" selected>احترافية</option>
              <option value="friendly">ودّية</option>
              <option value="bold">جريئة</option>
              <option value="insightful">تثقيفية</option>
            </select>
          </div>

          <div class="field">
            <label for="audience">الجمهور</label>
            <select id="audience">
              <option value="business" selected>رواد الأعمال</option>
              <option value="executives">قيادات</option>
              <option value="general">عام</option>
            </select>
          </div>

          <div class="field">
            <label for="language">اللغة</label>
            <select id="language">
              <option value="ar" selected>العربية</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="btn" class="btn-primary" onclick="run()">توليد المحتوى</button>
          <button class="btn-secondary" onclick="copyAll()">نسخ الكل</button>

          <div class="meta">
            <span id="status" class="chip">—</span>
            <span id="debug" class="chip">—</span>
          </div>
        </div>

        <div class="hint">
          النتيجة قابلة للتعديل قبل النشر
        </div>
      </section>

      <section class="grid">
        <div class="card output-card">
          <div class="output-head">
            <div class="title">X</div>
            <div class="counter"><span id="xCount">0</span>/280</div>
            <button class="btn-mini" onclick="copyText('outX')">نسخ X</button>
          </div>
          <pre id="outX" class="output"></pre>
        </div>

        <div class="card output-card">
          <div class="output-head">
            <div class="title">LinkedIn</div>
            <button class="btn-mini" onclick="copyText('outLinkedIn')">نسخ LinkedIn</button>
          </div>
          <pre id="outLinkedIn" class="output"></pre>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      Nashr © 2025 • Demo Version
    </footer>
  </div>

<script>
async function run() {
  const btn = document.getElementById("btn");
  const status = document.getElementById("status");
  const debug = document.getElementById("debug");

  const text = document.getElementById("text").value.trim();
  const platform = document.getElementById("platform").value;
  const tone = document.getElementById("tone").value;
  const audience = document.getElementById("audience").value;
  const language = document.getElementById("language").value; // ar | en

  if (!text) {
    alert(language === "en" ? "Please type a topic/idea." : "يرجى كتابة الفكرة أو الموضوع");
    return;
  }

  btn.disabled = true;
  status.textContent = "⏳ جاري التوليد...";
  debug.textContent = "";

  // تفريغ المخرجات قبل التوليد
  renderOutputs({ x: "", linkedin: "" });

  try {
    const res = await fetch("/api/run", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text,
        platform,
        tone,
        audience,
        language   // ← مهم
      })
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      throw new Error(data.error || "فشل التوليد");
    }

    // ✅ عرض الناتج مباشرة بدون split
    renderOutputs(data.output || { x:"", linkedin:"" });

    status.textContent = "✅ تم التوليد";
    debug.textContent = `HTTP ${res.status}`;

  } catch (err) {
    status.textContent = "❌ حدث خطأ";
    debug.textContent = err.message || "Unknown error";
  } finally {
    btn.disabled = false;
  }
}

function renderOutputs(output) {
  const outX = document.getElementById("outX");
  const outLinkedIn = document.getElementById("outLinkedIn");

  const xText = (output?.x || "").trim();
  const liText = (output?.linkedin || "").trim();

  outX.textContent = xText || "—";
  outLinkedIn.textContent = liText || "—";

  setXCounter(xText);
}

function setXCounter(text) {
  const xCount = document.getElementById("xCount");
  const len = (text || "").length;
  xCount.textContent = String(len);
}

function copyText(id) {
  const el = document.getElementById(id);
  const txt = el?.textContent || "";
  if (!txt || txt === "—") return;
  navigator.clipboard.writeText(txt);
}

function copyAll() {
  const x = document.getElementById("outX").textContent || "";
  const li = document.getElementById("outLinkedIn").textContent || "";
  const combined =
    `X:\n${x}\n\n---\n\nLinkedIn:\n${li}`.trim();
  navigator.clipboard.writeText(combined);
}
</script>
</body>
</html>