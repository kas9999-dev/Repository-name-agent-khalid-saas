<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nashr â€” App</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__title">Nashr</div>
      <div class="brand__sub">Demo Version â€¢ 2025</div>
    </div>

    <div class="topbar__links">
      <a class="pill" href="/health" target="_blank">health</a>
      <a class="pill" href="/api/run" target="_blank">API: /api/run</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <div class="field field--full">
          <label for="text">Ø§Ù„ÙÙƒØ±Ø© / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
          <textarea id="text" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙÙƒØ±Ø© Ù‡Ù†Ø§..."></textarea>
          <div class="hint">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±</div>
        </div>

        <div class="field">
          <label for="platform">Ø§Ù„Ù…Ù†ØµØ©</label>
          <select id="platform">
            <option>LinkedIn + X</option>
            <option>LinkedIn</option>
            <option>X</option>
          </select>
        </div>

        <div class="field">
          <label for="tone">Ø§Ù„Ù†Ø¨Ø±Ø©</label>
          <select id="tone">
            <option>Ø§Ø­ØªØ±Ø§ÙÙŠØ©</option>
            <option>ÙˆØ¯ÙŠØ©</option>
            <option>Ø­Ù…Ø§Ø³ÙŠØ©</option>
            <option>Ù…Ø®ØªØµØ±Ø©</option>
          </select>
        </div>

        <div class="field">
          <label for="audience">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</label>
          <select id="audience">
            <option>Ø±ÙˆØ§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</option>
            <option>Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠÙˆÙ†</option>
            <option>Ø§Ù„Ù…Ù‡ØªÙ…ÙˆÙ† Ø¨Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
            <option>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙˆÙ†</option>
          </select>
        </div>

        <div class="field">
          <label for="language">Ø§Ù„Ù„ØºØ©</label>
          <select id="language">
            <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btn" class="btn" onclick="run()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>

        <button id="copyClean" class="btn btn--ghost" onclick="copyClean()">Ù†Ø³Ø® Ù†Ø¸ÙŠÙ</button>

        <div class="meta">
          <span id="status" class="status">Ø¬Ø§Ù‡Ø²</span>
          <span id="debug" class="debug"></span>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="panel">
        <div class="panel__head">
          <div class="panel__title">X</div>
          <div class="panel__tools">
            <span class="counter" id="xCount">0/280</span>
            <button class="mini" onclick="copyText('xOut')">Ù†Ø³Ø® X</button>
          </div>
        </div>
        <pre class="panel__body" id="xOut"></pre>
      </div>

      <div class="panel">
        <div class="panel__head">
          <div class="panel__title">LinkedIn</div>
          <div class="panel__tools">
            <button class="mini" onclick="copyText('liOut')">Ù†Ø³Ø® LinkedIn</button>
          </div>
        </div>
        <pre class="panel__body" id="liOut"></pre>
      </div>
    </section>

    <section class="card history">
      <div class="history__head">
        <div class="history__title">Ø¢Ø®Ø± 3 ØªÙˆÙ„ÙŠØ¯Ø§Øª</div>
        <button class="mini" onclick="clearHistory()">Ù…Ø³Ø­</button>
      </div>
      <div id="historyList" class="history__list"></div>
    </section>

    <footer class="footer">Nashr Â© 2025 â€¢ Demo Version</footer>
  </main>

<script>
  const LS_KEY = "nashr_history_v1";

  function setDirByLang(lang) {
    const html = document.documentElement;
    if (lang === "en") {
      html.lang = "en";
      html.dir = "ltr";
    } else {
      html.lang = "ar";
      html.dir = "rtl";
    }
  }

  function updateXCount(text) {
    const c = document.getElementById("xCount");
    const n = (text || "").length;
    c.textContent = `${n}/280`;
  }

  function renderOutputs(output) {
    const xOut = document.getElementById("xOut");
    const liOut = document.getElementById("liOut");

    xOut.textContent = output?.x || "";
    liOut.textContent = output?.linkedin || "";

    updateXCount(output?.x || "");
  }

  function getCleanText() {
    const x = (document.getElementById("xOut").textContent || "").trim();
    const li = (document.getElementById("liOut").textContent || "").trim();
    const platform = document.getElementById("platform").value;

    if (platform.includes("LinkedIn") && platform.includes("X")) {
      return [x ? `X:\n${x}` : "", li ? `LinkedIn:\n${li}` : ""]
        .filter(Boolean)
        .join("\n\n---\n\n")
        .trim();
    }
    if (platform.includes("LinkedIn")) return li || "";
    return x || "";
  }

  async function copyClean() {
    const t = getCleanText();
    if (!t) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù†Ø³Ø®Ù‡");
    await navigator.clipboard.writeText(t);
    toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® (Ù†Ø¸ÙŠÙ)");
  }

  async function copyText(id) {
    const t = (document.getElementById(id).textContent || "").trim();
    if (!t) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù†Ø³Ø®Ù‡");
    await navigator.clipboard.writeText(t);
    toast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®");
  }

  function toast(msg) {
    const status = document.getElementById("status");
    status.textContent = msg;
    setTimeout(() => status.textContent = "Ø¬Ø§Ù‡Ø²", 1500);
  }

  function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "";
    const raw = localStorage.getItem(LS_KEY);
    const items = raw ? JSON.parse(raw) : [];

    if (!items.length) {
      el.innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</div>`;
      return;
    }

    items.forEach((it, idx) => {
      const card = document.createElement("div");
      card.className = "history__item";
      card.innerHTML = `
        <div class="history__meta">
          <div>${it.platform} â€¢ ${it.language.toUpperCase()}</div>
          <div class="history__time">${new Date(it.ts).toLocaleString()}</div>
        </div>
        <pre class="history__text">${escapeHtml(it.clean)}</pre>
        <div class="history__actions">
          <button class="mini" data-i="${idx}">Ù†Ø³Ø®</button>
        </div>
      `;
      card.querySelector("button").onclick = async () => {
        await navigator.clipboard.writeText(it.clean);
        toast("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¬Ù„");
      };
      el.appendChild(card);
    });
  }

  function saveHistory(entry) {
    const raw = localStorage.getItem(LS_KEY);
    const items = raw ? JSON.parse(raw) : [];
    items.unshift(entry);
    const trimmed = items.slice(0, 3);
    localStorage.setItem(LS_KEY, JSON.stringify(trimmed));
    loadHistory();
  }

  function clearHistory() {
    localStorage.removeItem(LS_KEY);
    loadHistory();
    toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù…Ø³Ø­");
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  async function run() {
    const btn = document.getElementById("btn");
    const status = document.getElementById("status");
    const debug = document.getElementById("debug");

    const text = document.getElementById("text").value.trim();
    const platform = document.getElementById("platform").value;
    const tone = document.getElementById("tone").value;
    const audience = document.getElementById("audience").value;
    const language = document.getElementById("language").value; // ar | en

    setDirByLang(language);

    if (!text) {
      alert(language === "en" ? "Please write a topic." : "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙÙƒØ±Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹");
      return;
    }

    btn.disabled = true;
    status.textContent = language === "en" ? "â³ Generating..." : "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...";
    debug.textContent = "";

    // clear outputs
    renderOutputs({ x: "", linkedin: "" });

    try {
      const res = await fetch("/api/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, platform, tone, audience, language })
      });

      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Generation failed");
      }

      renderOutputs(data.output);

      status.textContent = language === "en" ? "âœ… Done" : "âœ… ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯";
      debug.textContent = `HTTP ${res.status}`;

      const clean = getCleanText();
      saveHistory({
        ts: Date.now(),
        platform,
        language,
        clean
      });

    } catch (err) {
      status.textContent = language === "en" ? "âŒ Error" : "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£";
      debug.textContent = err?.message || "Unknown error";
    } finally {
      btn.disabled = false;
    }
  }

  // init
  document.getElementById("language").addEventListener("change", (e) => {
    setDirByLang(e.target.value);
  });

  loadHistory();
</script>
</body>
</html>