<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Nashr â€“ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#15203a,#0b1220);color:#e6ebf2}
    .container{max-width:1100px;margin:auto;padding:40px 20px}
    h1{text-align:center;margin-bottom:12px}
    .sub{text-align:center;color:#9aa4b2;margin-bottom:22px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px}
    label{display:block;margin-bottom:6px;font-size:14px;color:#9aa4b2}
    textarea,select{width:100%;background:#0b1220;color:#e6ebf2;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:12px;font-size:14px;margin-bottom:14px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:#4da3ff;color:#fff;border:none;padding:12px 18px;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer}
    button.secondary{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#e6ebf2}
    button:disabled{opacity:.6;cursor:not-allowed}
    .output{white-space:pre-wrap;line-height:1.8;font-size:14px;background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;min-height:220px}
    .meta{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px;color:#9aa4b2;font-size:12px;flex-wrap:wrap}
    .pill{border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.04)}
    .split-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title{font-weight:900}
    .counter{opacity:.9}
    footer{text-align:center;margin-top:22px;color:#9aa4b2;font-size:13px}
    a{color:#9fc7ff}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§  Nashr â€“ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
    <div class="sub">Ø§ÙƒØªØ¨ Ø§Ù„ÙÙƒØ±Ø©ØŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµØ©ØŒ ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯</div>

    <div class="card">
      <label>Ø§Ù„ÙÙƒØ±Ø© / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
      <textarea id="text" placeholder="Ø§ÙƒØªØ¨ ÙÙƒØ±ØªÙƒ Ù‡Ù†Ø§..."></textarea>

      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>Ø§Ù„Ù…Ù†ØµØ©</label>
          <select id="platform">
            <option value="Both">LinkedIn + X</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="X">X</option>
          </select>
        </div>

        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button id="runBtn" type="button">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
          <button id="copyAllBtn" class="secondary" type="button" disabled>Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>

      <div class="meta">
        <span class="pill">API: /api/run</span>
        <span class="pill"><a href="/health" target="_blank" rel="noopener">health</a></span>
        <span class="pill" id="status">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²</span>
        <span class="pill" id="debug">â€”</span>
      </div>
    </div>

    <div class="grid">
      <!-- X -->
      <div class="card">
        <div class="split-head">
          <div class="title">X</div>
          <div class="pill counter" id="xCounter">280 / 0</div>
        </div>
        <div id="outX" class="output">â€”</div>
        <div class="meta">
          <span class="pill" id="xState">â€”</span>
          <button id="copyXBtn" class="secondary" type="button" disabled>Ù†Ø³Ø® X</button>
        </div>
      </div>

      <!-- LinkedIn -->
      <div class="card">
        <div class="split-head">
          <div class="title">LinkedIn</div>
          <div class="pill" id="liState">â€”</div>
        </div>
        <div id="outLinkedIn" class="output">â€”</div>
        <div class="meta">
          <span class="pill">â€”</span>
          <button id="copyLiBtn" class="secondary" type="button" disabled>Ù†Ø³Ø® LinkedIn</button>
        </div>
      </div>
    </div>

    <footer>Nashr Â© 2025 Â· Demo Version</footer>
  </div>

<script>
  // ===== Elements =====
  const btn = document.getElementById("runBtn");
  const status = document.getElementById("status");
  const debug = document.getElementById("debug");

  const outX = document.getElementById("outX");
  const outLinkedIn = document.getElementById("outLinkedIn");

  const xCounter = document.getElementById("xCounter");
  const xState = document.getElementById("xState");
  const liState = document.getElementById("liState");

  const copyAllBtn = document.getElementById("copyAllBtn");
  const copyXBtn = document.getElementById("copyXBtn");
  const copyLiBtn = document.getElementById("copyLiBtn");

  // ===== State =====
  let lastFull = "";
  let lastX = "";
  let lastLi = "";

  // ===== Helpers =====
  function normalize(s){
    return String(s || "")
      .replace(/\r/g, "")
      .replace(/\u200f|\u200e/g, "") // RTL/LTR marks
      .trim();
  }

  function setXCounter(text){
    const t = normalize(text);
    xCounter.textContent = `280 / ${t.length}`;
    if (t.length > 280) {
      xState.textContent = `âš ï¸ ØªØ¬Ø§ÙˆØ² 280 (Ø§Ù„Ø¢Ù† ${t.length})`;
    } else if (t.length === 0) {
      xState.textContent = "â€”";
    } else {
      xState.textContent = `Ø¬Ø§Ù‡Ø² âœ… (${t.length}/280)`;
    }
  }

  async function copyToClipboard(text){
    const t = normalize(text);
    if(!t) return;
    try{
      await navigator.clipboard.writeText(t);
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
  }

  // ===== Split & Render (FIXED) =====
  function splitOutput(full){
    const t = normalize(full);

    // Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù…Ø±Ù†Ø©)
    const reLI = /(^|\n)\s*(LinkedIn|Ù„ÙŠÙ†ÙƒØ¯?Ù†)\s*[:ï¼š]?\s*(\n|$)/i;
    const reX  = /(^|\n)\s*(X|Ø§ÙƒØ³|Ø¥ÙƒØ³)\s*[:ï¼š]?\s*(\n|$)/i;

    const mLi = reLI.exec(t);
    const mX  = reX.exec(t);

    if (!mLi || !mX) {
      return { okSplit: false, raw: t, li: "", x: "" };
    }

    const liStart = mLi.index + mLi[0].length;
    const xStart  = mX.index + mX[0].length;

    // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
    if (xStart > liStart) {
      const li = t.slice(liStart, mX.index).trim();
      const x  = t.slice(xStart).trim();
      return { okSplit: true, li, x, raw: t };
    } else {
      const x  = t.slice(xStart, mLi.index).trim();
      const li = t.slice(liStart).trim();
      return { okSplit: true, li, x, raw: t };
    }
  }

  function render(platform, fullText){
    lastFull = normalize(fullText);

    // reset
    outLinkedIn.innerText = "â€”";
    outX.innerText = "â€”";
    liState.textContent = "â€”";
    setXCounter("");

    lastLi = "";
    lastX = "";

    const parts = splitOutput(lastFull);

    if(platform === "Both"){
      if(parts.okSplit){
        lastLi = parts.li || "";
        lastX  = parts.x || "";
        outLinkedIn.innerText = lastLi || "â€”";
        outX.innerText = lastX || "â€”";
        liState.textContent = lastLi ? "Ø¬Ø§Ù‡Ø² âœ…" : "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        setXCounter(lastX || "");
      } else {
        // âœ… Fallback: Ù„Ø§ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù†Ø§ØªØ¬ ÙŠØ®ØªÙÙŠ
        lastLi = parts.raw || lastFull;
        outLinkedIn.innerText = lastLi || "â€”";
        outX.innerText = "â€”";
        liState.textContent = "ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ù‹Ø§ (ØªØ¹Ø°Ø± Ø§Ù„ØªÙ‚Ø³ÙŠÙ…) âš ï¸";
        setXCounter("");
      }
    }

    if(platform === "LinkedIn"){
      lastLi = parts.raw || lastFull;
      outLinkedIn.innerText = lastLi || "â€”";
      outX.innerText = "â€”";
      liState.textContent = lastLi ? "Ø¬Ø§Ù‡Ø² âœ…" : "â€”";
      setXCounter("");
    }

    if(platform === "X"){
      lastX = parts.raw || lastFull;
      outX.innerText = lastX || "â€”";
      outLinkedIn.innerText = "â€”";
      liState.textContent = "â€”";
      setXCounter(lastX || "");
    }

    // Buttons enablement
    copyAllBtn.disabled = !lastFull;
    copyLiBtn.disabled = !lastLi;
    copyXBtn.disabled = !lastX;

    // Debug: Ø·ÙˆÙ„ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
    debug.textContent = `len ${lastFull.length}`;
  }

  // ===== Actions =====
  btn.addEventListener("click", run);

  copyAllBtn.addEventListener("click", async () => {
    await copyToClipboard(lastFull);
  });
  copyXBtn.addEventListener("click", async () => {
    await copyToClipboard(lastX);
  });
  copyLiBtn.addEventListener("click", async () => {
    await copyToClipboard(lastLi);
  });

  async function run(){
    const text = document.getElementById("text").value.trim();
    const platform = document.getElementById("platform").value;

    if(!text){ alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙÙƒØ±Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }

    btn.disabled = true;
    status.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
    debug.textContent = "â€”";

    outLinkedIn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...";
    outX.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...";
    liState.textContent = "â€”";
    setXCounter("");

    lastFull = "";
    lastX = "";
    lastLi = "";
    copyAllBtn.disabled = true;
    copyLiBtn.disabled = true;
    copyXBtn.disabled = true;

    try{
      const res = await fetch("/api/run", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, platform, tone:"Ø§Ø­ØªØ±Ø§ÙÙŠØ©", audience:"Ø±ÙˆØ§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„" })
      });

      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));

      status.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… âœ…";
      debug.textContent = "HTTP " + res.status;

      render(platform, data.output || "");
    }catch(e){
      status.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ âŒ";
      debug.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† /health Ùˆ Logs";
      outLinkedIn.innerText = "âŒ Ø®Ø·Ø£: " + (e.message || e);
      outX.innerText = "â€”";
      liState.textContent = "â€”";
      setXCounter("");
    }finally{
      btn.disabled = false;
    }
  }
</script>
</body>
</html>